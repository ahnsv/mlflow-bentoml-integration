version: '3.8'

services: 
    artifacts:
        image: localstack/localstack
        container_name: artifacts
        environment: 
            - LOCALSTACK_SERVICES=s3
        ports:
            - "4566-4599:4566-4599"
            - "${PORT_WEB_UI-8080}:${PORT_WEB_UI-8080}"
        networks: 
            - mlflow
        volumes: 
            - ./create_bucket.sh:/docker-entrypoint-initaws.d
        
    
    db:
        image: mysql/mysql-server:8.0-aarch64
        container_name: db
        ports:
            - 3306:3306
        networks:
            - mlflow
        environment:
            - MYSQL_DATABASE=${MYSQL_DATABASE:-mlflow}
            - MYSQL_USER=${MYSQL_USER:-mlflow}
            - MYSQL_PASSWORD=${MYSQL_PASSWORD:-mlflow}
            - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-mlflow}
        volumes:
            - ./dbdata:/var/lib/mysql
    
    tracking_server:
        container_name: tracking_server
        depends_on: 
            - db
            - artifacts
        build: 
            context: ./mlflow
            dockerfile: Dockerfile
        ports:
            - "5000:5000"
        networks: 
            - mlflow
        environment: 
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-mlflow}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-mlflow}
            - AWS_DEFAULT_REGION=${AWS_REGION:-us-east-1}
            - MLFLOW_S3_ENDPOINT_URL=http://artifacts:4566
        entrypoint: mlflow server --backend-store-uri mysql+pymysql://${MYSQL_USER:-mlflow}:${MYSQL_PASSWORD:-mlflow}@db:3306/${MYSQL_DATABASE:-mlflow} --default-artifact-root s3://mlflow/ -h 0.0.0.0

networks: 
    mlflow:
        external:
            name: mlflow